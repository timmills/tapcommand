# TapCommand Deployment Guide

Complete guide for deploying TapCommand on Ubuntu 24 Server.

## Table of Contents
- [Quick Start](#quick-start)
- [Prerequisites](#prerequisites)
- [Installation](#installation)
- [Configuration](#configuration)
- [Updates](#updates)
- [Database Management](#database-management)
- [Troubleshooting](#troubleshooting)
- [Release Workflow](#release-workflow)

---

## Quick Start

For a fresh Ubuntu 24 server:

```bash
# Clone the repository
git clone <your-repo-url> /opt/tapcommand
cd /opt/tapcommand

# Checkout release branch
git checkout release  # or main, depending on your strategy

# Run installation
./install.sh
```

That's it! The script handles everything automatically.

---

## Prerequisites

### Minimum System Requirements
- **OS**: Ubuntu 24.04 LTS (or compatible)
- **RAM**: 2GB minimum, 4GB recommended
- **Disk**: 10GB free space
- **Network**: Internal network access for device discovery
- **Permissions**: Sudo access for installation

### Software Requirements (Auto-installed)
- Python 3.12+
- Node.js 22+
- npm 11+
- nginx
- sqlite3
- nmap (for network discovery)
- avahi-utils (for mDNS)

---

## Installation

### Step 0: Prerequisites (Fresh Server Only)

If your Ubuntu server doesn't have `git` installed:

```bash
sudo apt-get update
sudo apt-get install -y git curl

# OR use the bootstrap script (after downloading manually):
wget https://raw.githubusercontent.com/<your-repo>/release/bootstrap.sh
chmod +x bootstrap.sh
./bootstrap.sh
```

**Note:** The main `install.sh` script will install all other dependencies automatically.

### Step 1: Clone Repository

```bash
# Choose installation directory (recommend /opt/tapcommand)
sudo mkdir -p /opt/tapcommand
sudo chown $USER:$USER /opt/tapcommand

# Clone and checkout release branch
git clone -b release <your-repo-url> /opt/tapcommand
cd /opt/tapcommand

# Verify you're on release branch
git branch --show-current  # Should show 'release'
```

### Step 2: Run Installer

```bash
# Make installer executable (if not already)
chmod +x install.sh

# Run installation
./install.sh
```

The installer will:
1. ✓ Check system compatibility
2. ✓ Install system dependencies (Python, Node, nginx, etc.)
3. ✓ Set up Python virtual environment
4. ✓ Install Python packages
5. ✓ Install Node packages and build frontend
6. ✓ Initialize database (from template or fresh)
7. ✓ Create environment configuration files
8. ✓ Set up systemd services
9. ✓ Configure nginx reverse proxy
10. ✓ Start all services
11. ✓ Verify installation

### Step 3: Access Application

After installation completes, access the application at:
```
http://<server-ip-address>
```

Default credentials will be shown during installation (check your user management docs).

---

## Configuration

### Environment Variables

#### Backend (`backend/.env`)
```bash
# Database
DATABASE_URL=sqlite:///./tapcommand.db

# JWT Configuration
SECRET_KEY=<auto-generated-secure-key>
ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=30

# CORS
CORS_ORIGINS=http://localhost:5173,http://localhost:3000

# Server
HOST=0.0.0.0
PORT=8000

# Logging
LOG_LEVEL=INFO
```

#### Frontend (`frontend-v2/.env.local`)
```bash
VITE_API_URL=http://<server-ip>:8000
```

### Nginx Configuration

Location: `/etc/nginx/sites-available/tapcommand`

The installer creates this automatically, but you can modify for:
- Custom domain names
- SSL/TLS certificates
- Custom ports
- Additional security headers

### Systemd Services

Two services are created:

1. **tapcommand-backend.service** - Backend API server
2. **tapcommand-frontend.service** - Frontend dev server (optional)

Service commands:
```bash
# View logs
sudo journalctl -u tapcommand-backend.service -f

# Restart service
sudo systemctl restart tapcommand-backend.service

# Check status
sudo systemctl status tapcommand-backend.service

# Stop service
sudo systemctl stop tapcommand-backend.service
```

---

## Updates

### Automated Update Process

```bash
cd /opt/tapcommand
./update.sh
```

The update script:
1. ✓ Checks for uncommitted changes
2. ✓ Creates database backup
3. ✓ Pulls latest code from git
4. ✓ Updates Python dependencies (if changed)
5. ✓ Updates Node dependencies (if changed)
6. ✓ Rebuilds frontend
7. ✓ Runs database migrations
8. ✓ Restarts services
9. ✓ Verifies update
10. ✓ Cleans old backups (keeps last 10)

### Manual Update

If you need more control:

```bash
cd /opt/tapcommand

# 1. Backup database
cp backend/tapcommand.db backend/tapcommand.db.backup

# 2. Pull changes
git pull origin release

# 3. Update backend
cd backend
source venv/bin/activate
pip install -r requirements.txt
deactivate

# 4. Update frontend
cd ../frontend-v2
npm install
npm run build

# 5. Run migrations if needed
cd ../backend
source venv/bin/activate
python migrate_database.py
deactivate

# 6. Restart services
sudo systemctl restart tapcommand-backend.service
sudo systemctl reload nginx
```

---

## Database Management

### Database Location
```
/opt/tapcommand/backend/tapcommand.db
```

### Creating Clean Template

To create a fresh database template (for releases):

```bash
cd /opt/tapcommand/backend
source venv/bin/activate
python create_template_db.py
deactivate
```

This creates `tapcommand_template.db` with:
- Schema structure
- Essential seed data (roles, default settings)
- IR code libraries
- No site-specific data

### Database Migrations

When schema changes between versions:

```bash
cd /opt/tapcommand/backend
source venv/bin/activate
python migrate_database.py
deactivate
```

This script:
- Analyzes current schema
- Detects missing tables/columns
- Creates backup automatically
- Applies necessary migrations
- Verifies database integrity

### Manual Backup

```bash
# Backup
cp backend/tapcommand.db backend/tapcommand_$(date +%Y%m%d_%H%M%S).db

# Restore
cp backend/tapcommand_20250401_120000.db backend/tapcommand.db
sudo systemctl restart tapcommand-backend.service
```

### Database Queries (Development)

```bash
sqlite3 backend/tapcommand.db

# Useful queries
sqlite> .tables                    # List all tables
sqlite> .schema users              # Show table schema
sqlite> SELECT * FROM users;       # Query data
sqlite> .quit                      # Exit
```

---

## Troubleshooting

### Backend Won't Start

```bash
# Check logs
sudo journalctl -u tapcommand-backend.service -n 100

# Common issues:
# 1. Port already in use
sudo lsof -i :8000

# 2. Database locked
# Stop service, check for other processes
ps aux | grep uvicorn

# 3. Permission issues
sudo chown -R $USER:$USER /opt/tapcommand
```

### Frontend Not Loading

```bash
# Check nginx is running
sudo systemctl status nginx

# Check nginx configuration
sudo nginx -t

# Check frontend build exists
ls -la /opt/tapcommand/frontend-v2/dist/

# Rebuild if needed
cd /opt/tapcommand/frontend-v2
npm run build
sudo systemctl reload nginx
```

### Network Discovery Not Working

```bash
# Check nmap is installed
which nmap

# Test network scanning manually
nmap -sn 192.168.1.0/24

# Check permissions (discovery needs network access)
# May need to run backend with CAP_NET_RAW capability
```

### Database Errors After Update

```bash
# Restore from backup
cd /opt/tapcommand
cp backups/tapcommand_<timestamp>.db backend/tapcommand.db
sudo systemctl restart tapcommand-backend.service

# Or run migration manually
cd backend
source venv/bin/activate
python migrate_database.py
```

### View All Service Logs

```bash
# Backend
sudo journalctl -u tapcommand-backend.service -f

# Nginx error log
sudo tail -f /var/log/nginx/error.log

# Nginx access log
sudo tail -f /var/log/nginx/access.log
```

---

## Release Workflow

### For Developers/Maintainers

#### 1. Prepare Release Branch

**First time setup:**
```bash
# Create release branch from main
git checkout main
git pull
git checkout -b release
git push -u origin release
```

**For each release:**
```bash
# Ensure main is stable and tested
git checkout main
git pull

# Merge to release
git checkout release
git merge main

# Create/update clean database template
cd backend
source venv/bin/activate
python create_template_db.py
deactivate

# Commit template
git add backend/tapcommand_template.db
git commit -m "chore: Update database template for v1.X.X"

# Push to GitHub
git push origin release
```

#### 2. Version Tagging

```bash
# Tag release
git tag -a v1.0.0 -m "Release version 1.0.0"
git push origin v1.0.0
```

#### 3. Update .gitignore for Releases

The current `.gitignore` excludes `*.db`, but we need the template:

```bash
# .gitignore already has:
*.db
!tapcommand_template.db  # Allow template

# OR use exception:
!backend/tapcommand_template.db
```

### For Site Administrators

#### Fresh Installation
```bash
git clone <repo> /opt/tapcommand
cd /opt/tapcommand
git checkout release
./install.sh
```

#### Updates
```bash
cd /opt/tapcommand
git checkout release
./update.sh
```

---

## Files Reference

### Installation Scripts
- `install.sh` - Main installation script
- `update.sh` - Update script with migrations
- `backend/create_template_db.py` - Create clean database template
- `backend/migrate_database.py` - Database migration utility

### Configuration Files
- `backend/.env` - Backend environment variables
- `frontend-v2/.env.local` - Frontend environment variables
- `/etc/nginx/sites-available/tapcommand` - Nginx configuration
- `/etc/systemd/system/tapcommand-backend.service` - Backend service
- `/etc/systemd/system/tapcommand-frontend.service` - Frontend service (dev)

### Data Files
- `backend/tapcommand.db` - Production database
- `backend/tapcommand_template.db` - Clean template (in git)
- `backups/` - Database backups (created by update.sh)

---

## Security Considerations

### Internal Network Only
This deployment is designed for internal networks. For internet-facing deployments:

1. **Add SSL/TLS**:
   ```bash
   sudo apt install certbot python3-certbot-nginx
   sudo certbot --nginx -d yourdomain.com
   ```

2. **Firewall**:
   ```bash
   sudo ufw allow 80/tcp
   sudo ufw allow 443/tcp
   sudo ufw enable
   ```

3. **Secure the database**:
   - Change default admin password immediately
   - Review user permissions
   - Consider database encryption

4. **Update SECRET_KEY**:
   - The installer generates a random key
   - Keep `backend/.env` secure
   - Don't commit `.env` to git

---

## Support

### Log Files
- Backend: `sudo journalctl -u tapcommand-backend.service`
- Nginx: `/var/log/nginx/error.log`
- Application: `backend/backend.log` (if configured)

### Health Checks
```bash
# Backend health
curl http://localhost:8000/api/health

# Frontend
curl http://localhost/
```

### Getting Help
- Check logs first
- Review this documentation
- Check GitHub issues (if applicable)
- Contact system administrator

---

## Appendix: Directory Structure

```
/opt/tapcommand/
├── backend/
│   ├── app/                    # Application code
│   ├── venv/                   # Python virtual environment
│   ├── tapcommand.db          # Production database
│   ├── tapcommand_template.db # Template database (in git)
│   ├── .env                   # Environment config (not in git)
│   ├── requirements.txt       # Python dependencies
│   ├── create_template_db.py  # Template creation script
│   └── migrate_database.py    # Migration utility
├── frontend-v2/
│   ├── src/                   # Source code
│   ├── dist/                  # Built files (served by nginx)
│   ├── node_modules/          # Node dependencies
│   ├── .env.local            # Frontend config (not in git)
│   └── package.json          # Node dependencies
├── backups/                   # Database backups (auto-created)
├── install.sh                # Installation script
├── update.sh                 # Update script
└── DEPLOYMENT.md             # This file
```
